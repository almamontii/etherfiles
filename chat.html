<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Anónimo - Etherfiles</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .grain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .grain::after {
            content: '';
            height: 400vh;
            width: 400vw;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='8.0' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            position: absolute;
            top: calc(50% - 400vh / 2);
            left: calc(50% - 400vw / 2);
            animation: grain 8s steps(10) infinite;
            opacity: 0.15;
            mix-blend-mode: darken;
        }

        @keyframes grain {
            0% {
                transform: translate(0%, 0%);
            }

            10% {
                transform: translate(-3%, -2%);
            }

            20% {
                transform: translate(2%, -3%);
            }

            30% {
                transform: translate(-4%, 1%);
            }

            40% {
                transform: translate(1%, 4%);
            }

            50% {
                transform: translate(-6%, 7%);
            }

            60% {
                transform: translate(3%, -5%);
            }

            70% {
                transform: translate(-2%, 3%);
            }

            80% {
                transform: translate(5%, -1%);
            }

            90% {
                transform: translate(-1%, -4%);
            }

            100% {
                transform: translate(0%, 0%);
            }
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(-3px);
        }

        .chat-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .chat-info {
            color: #888;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            background: #1DB954;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .chat-container {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            z-index: 2;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.own {
            align-self: flex-end;
            background: #0078d4;
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.other {
            align-self: flex-start;
            background: #2a2a2a;
            color: white;
            border: 1px solid #333;
            border-bottom-left-radius: 6px;
        }

        .message-time {
            font-size: 0.7rem;
            color: #666;
            margin-top: 4px;
            text-align: right;
        }

        .message.other .message-time {
            text-align: left;
        }

        .input-container {
            padding: 20px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #333;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #333;
            border-radius: 25px;
            background: #1a1a1a;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            border-color: #0078d4;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        .message-input::placeholder {
            color: #666;
        }

        .send-button {
            padding: 12px 20px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 25px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .send-button:hover {
            background: #106ebe;
            transform: translateY(-1px);
        }

        .send-button:disabled {
            background: #333;
            cursor: not-allowed;
            transform: none;
        }

        .welcome-message {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            margin: 40px 20px;
            padding: 30px;
            background: rgba(26, 26, 26, 0.5);
            border-radius: 12px;
            border: 1px solid #333;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 10px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingDot {

            0%,
            80%,
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .auto-delete-notice {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 15px;
            }

            .chat-title {
                font-size: 1.2rem;
            }

            .messages-container {
                padding: 15px;
            }

            .message {
                max-width: 85%;
                font-size: 0.9rem;
            }

            .input-container {
                padding: 15px;
            }

            .auto-delete-notice {
                bottom: 10px;
                right: 10px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>

<body>
    <div class="grain"></div>

    <div class="header">
        <a href="index.html" class="back-link">
            <span>←</span>
            <span>Volver</span>
        </a>
        <div class="chat-title">Chat Anónimo</div>
        <div class="chat-info">
            <div class="online-indicator"></div>
            <span id="onlineCount">1</span> conectados
            <div class="connection-notification" id="connectionNotification"></div>
        </div>
    </div>

    <div class="chat-container">
        <div class="messages-container" id="messagesContainer">
            <div class="welcome-message">
                <h3>¡Bienvenido al chat anónimo de Etherfiles!</h3>
                <p>Habla libremente, todos los mensajes se borran cada 24 horas.</p>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <input type="text" class="message-input" id="messageInput" placeholder="Escribe tu mensaje..."
                    maxlength="500">
                <button class="send-button" id="sendButton">Enviar</button>
            </div>
        </div>
    </div>

    <div class="auto-delete-notice">
        ⏰ Mensajes se borran cada 24h
    </div>

    <script>
        class AnonymousChat {
            constructor() {
                this.messages = [];
                this.userId = this.generateUserId();
                this.lastCleanup = localStorage.getItem('chatLastCleanup') || Date.now();
                this.typingTimeout = null;
                this.isTyping = false;

                this.initializeElements();
                this.setupEventListeners();
                this.loadMessages();
                this.startAutoCleanup();
                this.simulateOnlineUsers();
            }

            generateUserId() {
                let userId = localStorage.getItem('chatUserId');
                if (!userId) {
                    userId = 'user_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('chatUserId', userId);
                }
                return userId;
            }

            initializeElements() {
                this.messagesContainer = document.getElementById('messagesContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.onlineCount = document.getElementById('onlineCount');
            }

            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.messageInput.addEventListener('input', () => {
                    this.handleTyping();
                });
            }

            loadMessages() {
                const savedMessages = localStorage.getItem('chatMessages');
                if (savedMessages) {
                    this.messages = JSON.parse(savedMessages);
                    this.displayMessages();
                }
            }

            saveMessages() {
                localStorage.setItem('chatMessages', JSON.stringify(this.messages));
            }

            sendMessage() {
                const text = this.messageInput.value.trim();
                if (!text) return;

                const message = {
                    id: Date.now() + Math.random(),
                    text: text,
                    userId: this.userId,
                    timestamp: Date.now(),
                    isOwn: true
                };

                this.messages.push(message);
                this.displayMessage(message);
                this.saveMessages();
                this.messageInput.value = '';
                this.scrollToBottom();

                // Simular respuesta de otro usuario ocasionalmente
                if (Math.random() < 0.3) {
                    setTimeout(() => this.simulateResponse(), 2000 + Math.random() * 3000);
                }
            }

            simulateResponse() {
                const responses = [
                    "¡Hola! ¿Cómo estás?",
                    "Interesante punto de vista",
                    "Totalmente de acuerdo",
                    "¿Alguien más está aquí?",
                    "Me gusta este chat anónimo",
                    "¿Qué música escuchan?",
                    "Buenas vibraciones por aquí",
                    "¿Alguien conoce Etherfiles?",
                    "Chat muy relajado",
                    "¿Qué opinan de la música actual?"
                ];

                const randomResponse = responses[Math.floor(Math.random() * responses.length)];

                const message = {
                    id: Date.now() + Math.random(),
                    text: randomResponse,
                    userId: 'other_user_' + Math.random().toString(36).substr(2, 6),
                    timestamp: Date.now(),
                    isOwn: false
                };

                this.messages.push(message);
                this.displayMessage(message);
                this.saveMessages();
                this.scrollToBottom();
            }

            displayMessages() {
                this.messagesContainer.innerHTML = '';
                this.messages.forEach(message => this.displayMessage(message));
                this.scrollToBottom();
            }

            displayMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.isOwn ? 'own' : 'other'}`;

                const time = new Date(message.timestamp).toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                messageDiv.innerHTML = `
                    <div>${this.escapeHtml(message.text)}</div>
                    <div class="message-time">${time}</div>
                `;

                this.messagesContainer.appendChild(messageDiv);
            }

            handleTyping() {
                if (!this.isTyping) {
                    this.isTyping = true;
                    this.showTypingIndicator();
                }

                clearTimeout(this.typingTimeout);
                this.typingTimeout = setTimeout(() => {
                    this.isTyping = false;
                    this.hideTypingIndicator();
                }, 1000);
            }

            showTypingIndicator() {
                this.typingIndicator.style.display = 'block';
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                this.typingIndicator.style.display = 'none';
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }, 100);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            startAutoCleanup() {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000; // 24 horas en milisegundos

                if (now - this.lastCleanup > oneDay) {
                    this.cleanupOldMessages();
                    this.lastCleanup = now;
                    localStorage.setItem('chatLastCleanup', now.toString());
                }

                // Verificar cada hora si hay mensajes que limpiar
                setInterval(() => {
                    this.cleanupOldMessages();
                }, 60 * 60 * 1000);
            }

            cleanupOldMessages() {
                const oneDay = 24 * 60 * 60 * 1000;
                const cutoffTime = Date.now() - oneDay;

                const initialCount = this.messages.length;
                this.messages = this.messages.filter(message => message.timestamp > cutoffTime);

                if (this.messages.length !== initialCount) {
                    this.displayMessages();
                    this.saveMessages();
                    console.log(`Limpiados ${initialCount - this.messages.length} mensajes antiguos`);
                }
            }

            simulateOnlineUsers() {
                // Sistema realista de usuarios online basado en patrones de uso
                let currentUsers = 1; // Siempre al menos 1 (el usuario actual)
                let lastActivity = Date.now();
                let connectionHistory = [];
                
                // Simular patrones de conexión basados en la hora del día
                const getTimeBasedActivity = () => {
                    const hour = new Date().getHours();
                    // Más actividad en horas pico (12-14, 18-22)
                    if ((hour >= 12 && hour <= 14) || (hour >= 18 && hour <= 22)) {
                        return 0.4; // 40% probabilidad de conexión
                    } else if (hour >= 8 && hour <= 11) {
                        return 0.25; // 25% probabilidad
                    } else if (hour >= 15 && hour <= 17) {
                        return 0.3; // 30% probabilidad
                    } else {
                        return 0.15; // 15% probabilidad (noche/madrugada)
                    }
                };
                
                const updateOnlineCount = () => {
                    const now = Date.now();
                    const timeSinceLastActivity = now - lastActivity;
                    const activityProbability = getTimeBasedActivity();
                    
                    // Reducir usuarios si no hay actividad reciente
                    if (timeSinceLastActivity > 300000) { // 5 minutos
                        currentUsers = Math.max(1, currentUsers - 1);
                    } else if (timeSinceLastActivity > 600000) { // 10 minutos
                        currentUsers = Math.max(1, currentUsers - 2);
                    } else if (timeSinceLastActivity > 1200000) { // 20 minutos
                        currentUsers = Math.max(1, currentUsers - 3);
                    }
                    
                    // Simular conexiones basadas en la hora y actividad
                    if (Math.random() < activityProbability && currentUsers < 12) {
                        const newUsers = Math.floor(Math.random() * 2) + 1; // 1-2 usuarios
                        currentUsers = Math.min(12, currentUsers + newUsers);
                        lastActivity = now;
                        
                        // Registrar la conexión
                        connectionHistory.push({
                            time: now,
                            users: newUsers,
                            total: currentUsers
                        });
                        
                        // Mantener solo las últimas 10 conexiones
                        if (connectionHistory.length > 10) {
                            connectionHistory.shift();
                        }
                    }
                    
                    // Simular desconexiones ocasionales
                    if (Math.random() < 0.15 && currentUsers > 1) {
                        currentUsers = Math.max(1, currentUsers - 1);
                    }
                    
                    // Actualizar el contador con animación
                    this.updateUserCount(currentUsers);
                };

                // Actualizar cada 20-60 segundos para ser más realista
                updateOnlineCount();
                setInterval(updateOnlineCount, 20000 + Math.random() * 40000);
                
                // Registrar actividad cuando el usuario interactúa
                this.messageInput.addEventListener('input', () => {
                    lastActivity = Date.now();
                });
                
                this.sendButton.addEventListener('click', () => {
                    lastActivity = Date.now();
                });
                
                // Registrar actividad al hacer scroll
                this.messagesContainer.addEventListener('scroll', () => {
                    lastActivity = Date.now();
                });
            }
            
            updateUserCount(newCount) {
                const currentCount = parseInt(this.onlineCount.textContent);
                if (newCount !== currentCount) {
                    // Animación suave del cambio
                    this.onlineCount.style.transform = 'scale(1.1)';
                    this.onlineCount.style.color = newCount > currentCount ? '#1DB954' : '#ff6b6b';
                    
                    setTimeout(() => {
                        this.onlineCount.textContent = newCount;
                        this.onlineCount.style.transform = 'scale(1)';
                        this.onlineCount.style.color = '';
                    }, 200);
                }
            }
        }

        // Inicializar el chat cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            new AnonymousChat();
        });
    </script>
</body>

</html>
